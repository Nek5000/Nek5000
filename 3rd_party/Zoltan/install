#!/bin/bash
set -e

VER=3.901

if [ "$1" == "clean" ]; then
  rm -rf v$VER.tar.gz Zoltan lib include 2>/dev/null
  exit 0
fi

if [ -f ./lib/libzoltan.a ]; then
  exit 0
fi

if [ ! -d ./Zoltan ]; then
  mkdir Zoltan
  wget --no-check-certificate -O v$VER.tar.gz \
    https://github.com/sandialabs/Zoltan/archive/refs/tags/v$VER.tar.gz
  tar -zxvf v$VER.tar.gz -C ./Zoltan --strip-components=1
fi

INSTALL_DIR=`pwd`
PARMETIS_DIR=`pwd`/../parMETIS

mkdir -p Zoltan/build
cd Zoltan/build

set -x
../configure CC=$CC CXX=$CXX CFLAGS="$CFLAGS" CXXFLAGS="$CXXFLAGS" \
  --prefix=${INSTALL_DIR} \
  --enable-mpi \
  --with-mpi-compilers \
  --with-id-type=ulong \
  --with-gnumake \
  --with-parmetis \
  --with-parmetis-incdir="${PARMETIS_DIR}/include" \
  --with-parmetis-libdir="${PARMETIS_DIR}/lib"

make everything
make install
set +x

#!/bin/bash
set -e

VER=3.16

if [ "$1" == "clean" ]; then
  rm -rf v$VER.tar.gz KaHIP bin lib include 2>/dev/null
  exit 0
fi

if [ -f ./lib/libkahip.so ]; then
  exit 0
fi

if [ ! -d ./KaHIP ]; then
  mkdir KaHIP
  wget --no-check-certificate -O v$VER.tar.gz \
    https://github.com/KaHIP/KaHIP/archive/refs/tags/v$VER.tar.gz
  tar -zxvf v$VER.tar.gz -C ./KaHIP --strip-components=1
fi

INSTALL_DIR=`pwd`
mkdir -p KaHIP/build
cd KaHIP/build

set -x
CC=$CC CXX=$CXX cmake .. -DCMAKE_INSTALL_PREFIX=${INSTALL_DIR} \
  -DCMAKE_C_FLAGS="$CFLAGS" \
  -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
  -DCMAKE_BUILD_TYPE=Release
make -j4 install
set +x

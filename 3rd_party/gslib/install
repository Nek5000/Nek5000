#!/bin/bash
set -e

: ${NEK_DEPS_LOCAL_SRC:=0}
: ${VER:="1.0.9"}

PREFIX=gslib
DIR=${PREFIX}_v${VER}
STAMP_FILE=install.stamp
ROOT=$PWD

# use existing local src
if [[ $NEK_DEPS_LOCAL_SRC -eq 1 ]]; then
  DIR=${PREFIX}
  VER="local"
fi

clean() {
  rm -rf "$DIR/build" lib include $STAMP_FILE 2>/dev/null || true
  [ -L $PREFIX ] && rm -f -- $PREFIX 2>/dev/null || true # soft link only
  find . -name '*.o' -exec rm {} +
  find . -name '*.a' -exec rm {} +
}

distclean() {
  clean
  rm -rf ${PREFIX} ${PREFIX}_v* *.tar.gz 2>/dev/null || true
}

fetch() {
  rm -rf $DIR 2>/dev/null || true
  wget --no-check-certificate -O v$VER.tar.gz https://github.com/gslib/gslib/archive/v$VER.tar.gz
}

if [ "$1" == "clean" ]; then
   clean
   exit 0
fi

if [ "$1" == "distclean" ]; then
  distclean
  exit 0
fi

if [ "$1" == "fetch" ]; then
  distclean
  fetch
  exit 0
fi

if [ -f $STAMP_FILE ]; then
  stamp_ver=$(head -n 1 $STAMP_FILE)
  if [ "$stamp_ver" != "$VER" ]; then
    echo "Detected previously installed version: $stamp_ver (expected $VER)"
    echo "Cleaning and rebuilding..."
    clean
  fi
else
  clean
fi

if [ -f ./lib/libgs.a ]; then
  exit 0
fi

if [[ $NEK_DEPS_LOCAL_SRC -eq 0 ]]; then
  if [ ! -f v$VER.tar.gz ]; then
    fetch
  fi

  if [ ! -d $DIR ]; then
    mkdir $DIR
    tar -zxvf v$VER.tar.gz -C $DIR --strip-components=1
  fi
fi

cd $DIR
set -x
make -j4 $GSLIB_OPT
set +x

cd $ROOT
if [[ $NEK_DEPS_LOCAL_SRC -eq 0 ]]; then
  ln -sfn $DIR/ $PREFIX
fi

if [ "$?" -eq 0 ]; then
  cd $ROOT
  echo $VER > $STAMP_FILE
  echo "Successfully installed at $(date +"%Y-%m-%d %H:%M:%S %Z")" >> $STAMP_FILE
fi

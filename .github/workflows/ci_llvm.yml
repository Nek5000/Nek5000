name: CI (flang)

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master
      - flang-wip

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  LLVM_VER: "21.1.0"
  MPICH_VER: "4.2.2"
jobs:
  prepare-llvm:
    runs-on: ubuntu-22.04
    steps:
      - name: Restore LLVM cache
        uses: actions/cache@v4
        with:
          path: |
            #llvm-${{ env.LLVM_VER }}.tar.xz
            #LLVM-${{ env.LLVM_VER }} # too large, not fit in cache
            llvm-${{ env.LLVM_VER }}.tar.zst
            #mpich-${{ env.MPICH_VER }}.tar.gz
            mpich-install-${{ env.MPICH_VER }}
          key: ${{ runner.os }}-${{ runner.arch }}-llvm-${{ env.LLVM_VER }}-mpich-${{ env.MPICH_VER }}

      - name: Download & extract LLVM (cache-aware)
        shell: bash
        run: |
          set -euxo pipefail
          set -x

          case "${{ runner.arch }}" in
            X64)   LLVM_ARCH="Linux-X64" ;;
            ARM64) LLVM_ARCH="Linux-AArch64" ;;
            *) echo "Unsupported arch: ${{ runner.arch }}"; exit 1 ;;
          esac

          LLVM_SRC="LLVM-${LLVM_VER}-${LLVM_ARCH}"
          LLVM_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VER}/${LLVM_SRC}.tar.xz"

          LLVM_TAR="llvm-${{ env.LLVM_VER }}.tar.xz"
          LLVM_TAR_ZST="llvm-${{ env.LLVM_VER }}.tar.zst"

          LLVM_DIR="LLVM-${{ env.LLVM_VER }}"
          LLVM_BIN="$PWD/$LLVM_DIR/bin"
          LLVM_LIB="$PWD/$LLVM_DIR/lib"

          if [ ! -f "$LLVM_TAR_ZST" ]; then

            # download tar
            if [ ! -f "$LLVM_TAR" ]; then
              wget -q "$LLVM_URL" -O "$LLVM_TAR"
            fi

            # extract
            if [ ! -d "$LLVM_DIR" ]; then
              rm -rf "$LLVM_SRC"
              tar -xf "$LLVM_TAR"          # creates "$LLVM_SRC"
              mv "$LLVM_SRC" "$LLVM_DIR"   # normalize directory name
            fi

            # prepare zst for fast compression
            if [ ! -f "$LLVM_TAR_ZST" ]; then
              tar -cf - $LLVM_DIR | zstd -T0 -6 -o $LLVM_TAR_ZST
            fi

          fi
          set +x

      - name: Extract LLVM and add into PATH
        shell: bash
        run: |
          set -x

          case "${{ runner.arch }}" in
            X64)   LLVM_ARCH="Linux-X64" ;;
            ARM64) LLVM_ARCH="Linux-AArch64" ;;
            *) echo "Unsupported arch: ${{ runner.arch }}"; exit 1 ;;
          esac

          LLVM_TAR="llvm-${{ env.LLVM_VER }}.tar.xz"
          LLVM_TAR_ZST="llvm-${{ env.LLVM_VER }}.tar.zst"

          LLVM_DIR="LLVM-${{ env.LLVM_VER }}"
          LLVM_BIN="$PWD/$LLVM_DIR/bin"
          LLVM_LIB="$PWD/$LLVM_DIR/lib"

          if [ ! -d "$LLVM_DIR" ]; then
            tar --use-compress-program=zstd -xf $LLVM_TAR_ZST
          fi

          # For THIS step
          export PATH="$LLVM_BIN:$PATH"
          export LD_LIBRARY_PATH="$LLVM_LIB:${LD_LIBRARY_PATH:-}"
          export LIBRARY_PATH="$LLVM_LIB:${LIBRARY_PATH:-}"

          # For LATER steps
          echo "$LLVM_BIN" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$LLVM_LIB:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$LLVM_LIB:${LIBRARY_PATH:-}" >> "$GITHUB_ENV"

          # sanity check
          echo "=== path ==="
          ls -ltra $LLVM_BIN |grep clang
          ls -ltra $LLVM_BIN |grep flang

          echo "=== toolchain ==="
          command -v clang || true
          command -v flang || true
          clang --version
          flang --version
          find "$(dirname "$(command -v clang)")/../lib" -name 'libflang_rt.runtime*' | head -n 5 || true
          set +x

      - name: Build MPI (cache-aware)
        shell: bash
        run: |
          set -x
          MPICH_URL="https://www.mpich.org/static/downloads/${MPICH_VER}/mpich-${MPICH_VER}.tar.gz"
          MPICH_TAR="mpich-${{ env.MPICH_VER }}.tar.gz"
          MPICH_DIR="mpich-${{ env.MPICH_VER }}"
          MPICH_INSTALL="$PWD/mpich-install-${{ env.MPICH_VER }}"

          if [ ! -f "$MPICH_TAR" ]; then
            curl -L -o $MPICH_TAR $MPICH_URL
          fi

          if [ ! -d "$MPICH_INSTALL" ]; then
            tar -xf $MPICH_TAR
            cd $MPICH_DIR
            ./configure \
              CC=clang CXX=clang++ FC=flang F77=flang \
              --disable-fortran-optional-args \
              --prefix="$MPICH_INSTALL"
            make -j$(nproc)
            make install
          fi

          echo "=== wrappers ==="
          mpicc -show || true
          mpif77 -show || true
          set +x

#      - name: Upload LLVM artifact
#        uses: actions/upload-artifact@v4
#        with:
#          name: llvm-${{ env.LLVM_VER }}-${{ runner.arch }}
#          path: LLVM-${{ env.LLVM_VER }}-Linux-*
#          retention-days: 1
#          if-no-files-found: error

  main:
    needs: prepare-llvm
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        test_case: [
            "Tools",
            "Axi::test_PnPn_Parallel",
            "ConjHt::test_PnPn_Parallel",
            "Eddy_EddyUv::test_PnPn_Parallel",
            "Eddy_LegacySize::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn_Parallel",
            "Eddy_Neknek_mv::test_PnPn2_Parallel",
            "Eddy_Neknek_mv::test_PnPn_Parallel",
            "Eddy_Rich::test_PnPn2_Parallel",
            "Ethier::test_PnPn2_Parallel",
            "Ethier::test_PnPn_Parallel",
            "FsHydro::test_PnPn2_Parallel",
            "InclDef::test_PnPn_Serial",
            "IO_Test::test_PnPn2_Parallel",
            "KovStokes::test_PnPn2_Parallel",
            "KovStokes::test_PnPn_Parallel",
            "LowMachTest::test_PnPn_Parallel",
            "MvCylCvode::test_PnPn_Parallel",
            "chan2d::test_PnPn_Parallel",
            "eddy_mv::test_PnPn_Parallel",
            "lpm_one::test_PnPn_Parallel",
            "lpm_two::test_PnPn_Parallel",
            "impsrc_scalar::test_PnPn_Parallel",
            "bcid_test_3D::test_PnPn_Parallel",
            "bcid_test_2D::test_PnPn_Serial"
        ]
        include:
          - test_case: "Tools"
            mpi: no
      fail-fast: false

    name: "${{ matrix.test_case }}"

    env:
      TEST_CASE: ${{ matrix.test_case }}
      MPI: "${{ matrix.mpi == 'no' && '0' || '1' }}"
      #CC: "${{ matrix.mpi == 'no' && 'clang-21' || 'mpicc' }}"
      #FC: "${{ matrix.mpi == 'no' && 'flang-21' || 'mpif77' }}"
      CC: ${{ matrix.mpi == 'no' && 'clang' || 'mpicc' }}
      FC: ${{ matrix.mpi == 'no' && 'flang' || 'mpif77' }}
      OMPI_CC: clang
      OMPI_FC: flang
      MPICH_CC: clang
      MPICH_FC: flang

    steps:
      - uses: actions/checkout@v4

#      - name: Download LLVM artifact
#        uses: actions/download-artifact@v4
#        with:
#          name: llvm-${{ env.LLVM_VER }}-${{ runner.arch }}
#          path: .

      - name: Restore LLVM cache
        uses: actions/cache@v4
        with:
          path: |
            #llvm-${{ env.LLVM_VER }}.tar.xz
            #LLVM-${{ env.LLVM_VER }} # too large, not fit in cache
            llvm-${{ env.LLVM_VER }}.tar.zst
            #mpich-${{ env.MPICH_VER }}.tar.gz
            mpich-install-${{ env.MPICH_VER }}
          key: ${{ runner.os }}-${{ runner.arch }}-llvm-${{ env.LLVM_VER }}-mpich-${{ env.MPICH_VER }}

      - name: apt dependencies
        shell: bash
        run: |
          sudo apt -y update
          #sudo apt-get install -y wget gnupg lsb-release ca-certificates
          #wget -q https://apt.llvm.org/llvm.sh
          #chmod +x llvm.sh
          #sudo ./llvm.sh "${LLVM_VER}" all
          #sudo apt-get install -y flang-${LLVM_VER}
          #sudo apt install -y mpich libmpich-dev python3-pytest
          #sudo apt-get install -y openmpi-bin libopenmpi-dev python3-pytest
          sudo apt-get install -y python3-pytest

      - name: Extract LLVM and add into PATH
        shell: bash
        run: |
          set -x

          case "${{ runner.arch }}" in
            X64)   LLVM_ARCH="Linux-X64" ;;
            ARM64) LLVM_ARCH="Linux-AArch64" ;;
            *) echo "Unsupported arch: ${{ runner.arch }}"; exit 1 ;;
          esac

          LLVM_TAR="llvm-${{ env.LLVM_VER }}.tar.xz"
          LLVM_TAR_ZST="llvm-${{ env.LLVM_VER }}.tar.zst"

          LLVM_DIR="LLVM-${{ env.LLVM_VER }}"
          LLVM_BIN="$PWD/$LLVM_DIR/bin"
          LLVM_LIB="$PWD/$LLVM_DIR/lib"

          if [ ! -d "$LLVM_DIR" ]; then
            tar --use-compress-program=zstd -xf $LLVM_TAR_ZST
          fi

          # For THIS step
          export PATH="$LLVM_BIN:$PATH"
          export LD_LIBRARY_PATH="$LLVM_LIB:${LD_LIBRARY_PATH:-}"
          export LIBRARY_PATH="$LLVM_LIB:${LIBRARY_PATH:-}"

          # For LATER steps
          echo "$LLVM_BIN" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$LLVM_LIB:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$LLVM_LIB:${LIBRARY_PATH:-}" >> "$GITHUB_ENV"

          # sanity check
          echo "=== path ==="
          ls -ltra $LLVM_BIN |grep clang
          ls -ltra $LLVM_BIN |grep flang

          echo "=== toolchain ==="
          command -v clang || true
          command -v flang || true
          clang --version
          flang --version
          find "$(dirname "$(command -v clang)")/../lib" -name 'libflang_rt.runtime*' | head -n 5 || true
          set +x

      - name: Add MPICH to PATH
        shell: bash
        run: |
          set -x
          MPICH_INSTALL="$PWD/mpich-install-${{ env.MPICH_VER }}"
          MPICH_BIN="$MPICH_INSTALL/bin"
          MPICH_LIB="$MPICH_INSTALL/lib"

          # For THIS step
          export PATH="$MPICH_BIN:$PATH"
          export LD_LIBRARY_PATH="$MPICH_LIB:${LD_LIBRARY_PATH:-}"
          export LIBRARY_PATH="$MPICH_LIB:${LIBRARY_PATH:-}"

          # For LATER steps
          echo "$MPICH_BIN" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$MPICH_LIB:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$MPICH_LIB:${LIBRARY_PATH:-}" >> "$GITHUB_ENV"

          echo "=== wrappers ==="
          mpicc -show || true
          mpif77 -show || true
          set +x

      - name: test
        shell: bash
        run: |
          pytest-3 -s -v short_tests/NekTests.py::$TEST_CASE

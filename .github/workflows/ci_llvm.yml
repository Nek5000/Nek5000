name: CI (flang)

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master
      - flang-wip

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  LLVM_VER: "21"

jobs:
  prepare-llvm:
    runs-on: ubuntu-22.04
    steps:
      - name: Download + extract LLVM once
        shell: bash
        run: |
          set -euxo pipefail

          # pick arch tarball
          case "${{ runner.arch }}" in
            X64)   LLVM_ARCH="Linux-X64" ;;
            ARM64) LLVM_ARCH="Linux-AArch64" ;;
            *) echo "Unsupported arch: ${{ runner.arch }}"; exit 1 ;;
          esac

          LLVM_DIR="LLVM-${LLVM_VER}-${LLVM_ARCH}"
          LLVM_TAR="${LLVM_DIR}.tar.xz"
          LLVM_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VER}/${LLVM_TAR}"

          wget -q "$LLVM_URL" -O llvm.tar.xz
          tar -xf llvm.tar.xz

      - name: Upload LLVM artifact
        uses: actions/upload-artifact@v4
        with:
          name: llvm-${{ env.LLVM_VER }}-${{ runner.arch }}
          path: LLVM-${{ env.LLVM_VER }}-Linux-*
          retention-days: 1

  main:
    needs: prepare-llvm
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        test_case: [ 
            "Tools",
            "Axi::test_PnPn_Parallel",
            "ConjHt::test_PnPn_Parallel",
            "Eddy_EddyUv::test_PnPn_Parallel",
            "Eddy_LegacySize::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn_Parallel",
            "Eddy_Neknek_mv::test_PnPn2_Parallel",
            "Eddy_Neknek_mv::test_PnPn_Parallel",
            "Eddy_Rich::test_PnPn2_Parallel",
            "Ethier::test_PnPn2_Parallel",
            "Ethier::test_PnPn_Parallel",
            "FsHydro::test_PnPn2_Parallel",
            "InclDef::test_PnPn_Serial",
            "IO_Test::test_PnPn2_Parallel",
            "KovStokes::test_PnPn2_Parallel",
            "KovStokes::test_PnPn_Parallel",
            "LowMachTest::test_PnPn_Parallel",
            "MvCylCvode::test_PnPn_Parallel",
            "chan2d::test_PnPn_Parallel",
            "eddy_mv::test_PnPn_Parallel",
            "lpm_one::test_PnPn_Parallel",
            "lpm_two::test_PnPn_Parallel",
            "impsrc_scalar::test_PnPn_Parallel",
            "bcid_test_3D::test_PnPn_Parallel",
            "bcid_test_2D::test_PnPn_Serial" 
        ]
        include:
          - test_case: "Tools"
            mpi: no
      fail-fast: false

    name: "${{ matrix.test_case }}"

    env:
      TEST_CASE: ${{ matrix.test_case }}
      MPI: "${{ matrix.mpi == 'no' && '0' || '1' }}"
      CC: "${{ matrix.mpi == 'no' && 'clang-21' || 'mpicc' }}"
      FC: "${{ matrix.mpi == 'no' && 'flang-21' || 'mpif77' }}"
      MPICH_CC: clang-21
      MPICH_FC: flang-21
      OMPI_CC: clang-21
      OMPI_FC: flang-21

    steps:
      - uses: actions/checkout@v4

      - name: Download LLVM artifact
        uses: actions/download-artifact@v4
        with:
          name: llvm-${{ env.LLVM_VER }}-${{ runner.arch }}
          path: .

      - name: apt dependencies
        shell: bash
        run: |
          sudo apt -y update
          #sudo apt-get install -y wget gnupg lsb-release ca-certificates
          #wget -q https://apt.llvm.org/llvm.sh
          #chmod +x llvm.sh
          #sudo ./llvm.sh "${LLVM_VER}" all
          #sudo apt-get install -y flang-${LLVM_VER}
          #sudo apt install -y mpich libmpich-dev python3-pytest
          sudo apt-get install -y openmpi-bin libopenmpi-dev python3-pytest

          #set -x
          #pytest-3 --version

          #echo "=== toolchain ==="
          #command -v clang-${LLVM_VER} || true
          #command -v flang-${LLVM_VER} || true
          #clang-${LLVM_VER} --version
          #flang-${LLVM_VER} --version
          #find "$(dirname "$(command -v clang-${LLVM_VER})")/../lib" -name 'libflang_rt.runtime*' | head -n 5 || true

          #echo "=== wrappers ==="
          #mpicc -show || true
          #mpif77 -show || true
          #set +x

      - name: Add LLVM to PATH
        shell: bash
        run: |
          set -x
          LLVM_DIR="$(ls -d LLVM-${LLVM_VER}-Linux-* | head -n 1)"
          echo "$PWD/$LLVM_DIR/bin" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$PWD/$LLVM_DIR/lib:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$PWD/$LLVM_DIR/lib:$LIBRARY_PATH" >> "$GITHUB_ENV"

          echo "=== toolchain ==="
          command -v clang-${LLVM_VER} || true
          command -v flang-${LLVM_VER} || true
          clang-${LLVM_VER} --version
          flang-${LLVM_VER} --version
          find "$(dirname "$(command -v clang-${LLVM_VER})")/../lib" -name 'libflang_rt.runtime*' | head -n 5 || true

          echo "=== wrappers ==="
          mpicc -show || true
          mpif77 -show || true
          set +x

      - name: test
        shell: bash
        run: |
          pytest-3 -s -v short_tests/NekTests.py::$TEST_CASE

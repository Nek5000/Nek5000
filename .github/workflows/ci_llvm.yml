name: CI (flang)

on:
  # allows us to run workflows manually
  workflow_dispatch:

  pull_request:
    branches:
      - master
  push:
    branches:
      - master
      - flang-wip

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  LLVM_VER: "21.1.0"
  MPICH_VER: "4.2.2"
  CACHE_KEY: ${{ runner.os }}-${{ runner.arch }}-llvm-${{ env.LLVM_VER }}-mpich-${{ env.MPICH_VER }}

jobs:
  prepare-llvm:
    runs-on: ubuntu-22.04
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Restore cache (LLVM tar.zst + MPICH install tar.zst)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            llvm-${{ env.LLVM_VER }}.tar.zst
            mpich-install-${{ env.MPICH_VER }}.tar.zst
          key: ${{ env.CACHE_KEY }}

      - name: Build & pack LLVM + MPICH (only on cache miss)
        if: ${{ steps.cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          set -euxo pipefail
          set -x

          # ===== LLVM tar.zst =====
          case "${{ runner.arch }}" in
            X64)   LLVM_ARCH="Linux-X64" ;;
            ARM64) LLVM_ARCH="Linux-AArch64" ;;
            *) echo "Unsupported arch: ${{ runner.arch }}"; exit 1 ;;
          esac

          LLVM_SRC="LLVM-${LLVM_VER}-${LLVM_ARCH}"
          LLVM_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VER}/${LLVM_SRC}.tar.xz"
          LLVM_TAR="llvm-${{ env.LLVM_VER }}.tar.xz"
          LLVM_TAR_ZST="llvm-${{ env.LLVM_VER }}.tar.zst"
          LLVM_DIR="LLVM-${{ env.LLVM_VER }}"

          LLVM_BIN="$PWD/$LLVM_DIR/bin"
          LLVM_LIB="$PWD/$LLVM_DIR/lib"

          if [ ! -f "$LLVM_TAR_ZST" ]; then
            if [ ! -f "$LLVM_TAR" ]; then
              wget -q "$LLVM_URL" -O "$LLVM_TAR"
            fi

            rm -rf "${LLVM_SRC}" "${LLVM_DIR}"
            tar -xf "${LLVM_TAR}"
            mv "${LLVM_SRC}" "${LLVM_DIR}"
            rm -f "${LLVM_TAR}"
            tar -cf - "${LLVM_DIR}" | zstd -T0 -12 -o "${LLVM_TAR_ZST}"
            # -6: 3m35s, 2.4 GiB
            # -9: 4m10s, 2.35 GiB,
            # -12: 5m41s, 2.33 GiB,
          fi

          echo "=== path ==="
          ls -ltra $LLVM_BIN |grep clang
          ls -ltra $LLVM_BIN |grep flang

          echo "=== toolchain ==="
          command -v clang || true
          command -v flang || true
          clang --version
          flang --version
          find "$(dirname "$(command -v clang)")/../lib" -name 'libflang_rt.runtime*' | head -n 5 || true

          # ===== MPICH install tar.zst =====
          MPICH_URL="https://www.mpich.org/static/downloads/${MPICH_VER}/mpich-${MPICH_VER}.tar.gz"
          MPICH_TAR="mpich-${{ env.MPICH_VER }}.tar.gz"
          MPICH_DIR="mpich-${{ env.MPICH_VER }}"
          MPICH_INSTALL="$PWD/mpich-install-${{ env.MPICH_VER }}"
          MPICH_INSTALL_ZST="$PWD/mpich-install-${{ env.MPICH_VER }}.tar.zst"

          if [ ! -f "$MPICH_INSTALL_ZST" ]; then
            curl -L -o "${MPICH_TAR}" "${MPICH_URL}"
            rm -rf "${MPICH_DIR}" "${MPICH_INSTALL}"
            tar -xf "${MPICH_TAR}"
            rm -f "${MPICH_TAR}"

            # Use LLVM as toolchain
            export PATH="$PWD/${LLVM_DIR}/bin:$PATH"
            export LD_LIBRARY_PATH="$PWD/${LLVM_DIR}/lib:${LD_LIBRARY_PATH:-}"
            export LIBRARY_PATH="$PWD/${LLVM_DIR}/lib:${LIBRARY_PATH:-}"

            pushd "${MPICH_DIR}"
            ./configure \
              CC=clang CXX=clang++ FC=flang F77=flang \
              CFLAGS="-O2" CXXFLAGS="-O2" FFLAGS="-O2" FCFLAGS="-O2" \
              LDFLAGS="-fuse-ld=lld" \
              --disable-fortran-optional-args \
              --enable-shared --disable-static \
              --disable-cxx \
              --prefix="$MPICH_INSTALL"
            make -j"$(nproc)"
            make install
            popd

            rm -rf "${MPICH_DIR}"
            tar -cf - "${MPICH_INSTALL}" | zstd -T0 -12 -o "${MPICH_INSTALL_ZST}"
            rm -rf "${MPICH_INSTALL}"
          fi

          echo "=== wrappers ==="
          mpicc -show || true
          mpif77 -show || true
          set +x

      - name: Upload artifacts (fallback for same-run cache miss)
        if: ${{ steps.cache.outputs.cache-hit != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: toolchain-${{ env.CACHE_KEY }}
          path: |
            llvm-${{ env.LLVM_VER }}.tar.zst
            mpich-install-${{ env.MPICH_VER }}.tar.zst
          if-no-files-found: error
          retention-days: 1

  main:
    needs: prepare-llvm
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        test_case: [
            "Tools",
            "Axi::test_PnPn_Parallel",
            "ConjHt::test_PnPn_Parallel",
            "Eddy_EddyUv::test_PnPn_Parallel",
            "Eddy_LegacySize::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn2_Parallel",
            "Eddy_Neknek::test_PnPn_Parallel",
            "Eddy_Neknek_mv::test_PnPn2_Parallel",
            "Eddy_Neknek_mv::test_PnPn_Parallel",
            "Eddy_Rich::test_PnPn2_Parallel",
            "Ethier::test_PnPn2_Parallel",
            "Ethier::test_PnPn_Parallel",
            "FsHydro::test_PnPn2_Parallel",
            "InclDef::test_PnPn_Serial",
            "IO_Test::test_PnPn2_Parallel",
            "KovStokes::test_PnPn2_Parallel",
            "KovStokes::test_PnPn_Parallel",
            "LowMachTest::test_PnPn_Parallel",
            "MvCylCvode::test_PnPn_Parallel",
            "chan2d::test_PnPn_Parallel",
            "eddy_mv::test_PnPn_Parallel",
            "lpm_one::test_PnPn_Parallel",
            "lpm_two::test_PnPn_Parallel",
            "impsrc_scalar::test_PnPn_Parallel",
            "bcid_test_3D::test_PnPn_Parallel",
            "bcid_test_2D::test_PnPn_Serial"
        ]
        include:
          - test_case: "Tools"
            mpi: no
      fail-fast: false

    name: "${{ matrix.test_case }}"

    env:
      TEST_CASE: ${{ matrix.test_case }}
      MPI: "${{ matrix.mpi == 'no' && '0' || '1' }}"
      #CC: "${{ matrix.mpi == 'no' && 'clang-21' || 'mpicc' }}"
      #FC: "${{ matrix.mpi == 'no' && 'flang-21' || 'mpif77' }}"
      CC: ${{ matrix.mpi == 'no' && 'clang' || 'mpicc' }}
      FC: ${{ matrix.mpi == 'no' && 'flang' || 'mpif77' }}
      OMPI_CC: clang
      OMPI_FC: flang
      MPICH_CC: clang
      MPICH_FC: flang

    steps:
      - uses: actions/checkout@v4

      - name: apt dependencies
        shell: bash
        run: |
          sudo apt -y update
          #sudo apt-get install -y wget gnupg lsb-release ca-certificates
          #wget -q https://apt.llvm.org/llvm.sh
          #chmod +x llvm.sh
          #sudo ./llvm.sh "${LLVM_VER}" all
          #sudo apt-get install -y flang-${LLVM_VER}
          #sudo apt install -y mpich libmpich-dev python3-pytest
          #sudo apt-get install -y openmpi-bin libopenmpi-dev python3-pytest
          sudo apt-get install -y python3-pytest

      - name: Restore cache (preferred)
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            llvm-${{ env.LLVM_VER }}.tar.zst
            mpich-install-${{ env.MPICH_VER }}.tar.zst
          key: ${{ env.CACHE_KEY }}

      - name: Download artifacts (fallback when cache miss)
        if: ${{ steps.cache.outputs.cache-hit != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: toolchain-${{ env.CACHE_KEY }}
          path: .

      - name: Extract & export LLVM
        shell: bash
        run: |
          set -eux

          LLVM_DIR="LLVM-${{ env.LLVM_VER }}"
          LLVM_TAR_ZST="llvm-${{ env.LLVM_VER }}.tar.zst"
          if [ ! -d "$LLVM_DIR" ]; then
            tar --use-compress-program=zstd -xf $LLVM_TAR_ZST
          fi

          echo "$PWD/${LLVM_DIR}/bin" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$PWD/${LLVM_DIR}/lib:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$PWD/${LLVM_DIR}/lib:${LIBRARY_PATH:-}" >> "$GITHUB_ENV"

          echo "=== toolchain ==="
          clang --version
          flang --version
          set +x

      - name: Extract & export MPICH
        shell: bash
        run: |
          set -eux
          MPICH_INSTALL="mpich-install-${MPICH_VER}"
          MPICH_INSTALL_ZST="${MPICH_INSTALL}.tar.zst"
          if [ ! -d "${MPICH_INSTALL}" ]; then
            tar --use-compress-program=zstd -xf "${MPICH_INSTALL_ZST}"
          fi
          echo "$PWD/${MPICH_INSTALL}/bin" >> "$GITHUB_PATH"
          echo "LD_LIBRARY_PATH=$PWD/${MPICH_INSTALL}/lib:${LD_LIBRARY_PATH:-}" >> "$GITHUB_ENV"
          echo "LIBRARY_PATH=$PWD/${MPICH_INSTALL}/lib:${LIBRARY_PATH:-}" >> "$GITHUB_ENV"

          echo "=== wrappers ==="
          mpicc -show || true
          mpif77 -show || true
          set +x

      - name: test
        shell: bash
        run: |
          pytest-3 -s -v short_tests/NekTests.py::$TEST_CASE
